<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ app_title }}</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="logo">⚙</div>
        <div>
          <div class="title">Stellwerk</div>
          <div class="subtitle">Weichen stellen. Strecke fahren. Ziele erreichen.</div>
        </div>
      </div>
    </header>

    <main class="layout">
      <aside class="sidebar">
        <details class="card" id="goalsPanel">
          <summary>
            <h2 style="display:inline; margin:0">Ziele</h2>
          </summary>
          <form method="post" action="/goals" class="stack" style="margin-top:12px">
            <input name="title" placeholder="Neues Ziel…" />
            <textarea name="description" placeholder="Optional: Notizen / warum ist es wichtig?"></textarea>
            <button type="submit">Ziel anlegen</button>
          </form>
        </details>

        <details class="card" id="stellwerkePanel">
          <summary>
            <h3 style="display:inline; margin:0">Deine Stellwerke</h3>
          </summary>
          <div class="goal-list" style="margin-top:12px">
            {% if goals|length == 0 %}
              <div class="muted">Noch kein Ziel. Leg eins an.</div>
            {% endif %}
            {% for g in goals %}
              <a class="goal-item {% if selected_goal and g.id == selected_goal.id %}active{% endif %}" href="/?goal={{ g.id }}">
                <div class="goal-item-title">{{ g.title }}</div>
                <div class="goal-item-desc">{{ g.description }}</div>
              </a>
            {% endfor %}
          </div>
        </details>

      </aside>

      <section class="content">
        {% if not selected_goal %}
          <section class="card hero">
            <h1>Willkommen im Stellwerk</h1>
            <p>
              Du stellst nicht eine große Weiche, sondern viele kleine.
              Lege ein Ziel an, dann lass dir Aufgaben und Arbeitspakete planen.
            </p>
          </section>
        {% else %}
          <section class="card hero">
            <h1>{{ selected_goal.title }}</h1>
            <p class="prologue">{{ selected_goal.prologue or "" }}</p>
            <p class="muted">{{ selected_goal.description }}</p>
            {% if selected_goal.plan_source %}
              <div class="plan-source">Planquelle: <span class="pill">{{ "OpenAI" if selected_goal.plan_source == "openai" else "Altbestand" }}</span></div>
            {% endif %}
            {% if selected_goal.rallying_cry %}
              <div class="rally">{{ selected_goal.rallying_cry }}</div>
            {% endif %}
          </section>

          <section class="card">
            <div class="row">
              <h2>Plan</h2>
              <form method="post" action="/goals/{{ selected_goal.id }}/plan" class="row-right">
                <input name="context" placeholder="Optionaler Kontext (Zeit, Ressourcen, Constraints)…" />
                <button type="submit">KI: Plan erstellen</button>
              </form>
            </div>

            {% if plan_error %}
              <div class="alert" style="margin-top:12px">
                <div style="font-weight:800">Plan konnte nicht erstellt werden.</div>
                <div class="muted" style="margin-top:4px">{{ plan_error }}</div>
                <div class="muted" style="margin-top:6px">Hinweis: Für Planung wird `OPENAI_API_KEY` benötigt.</div>
              </div>
            {% endif %}

            {% if selected_goal.people|length > 0 or true %}
              <details class="people card" style="margin-top:12px">
                <summary style="cursor:pointer">
                  <h3 style="display:inline; margin:0">Begleiter & Helfer</h3>
                </summary>

                <div class="muted" style="margin:10px 0">
                  Begleiter ziehen mit dir. Helfer sind Personen, bei denen du vorangehst oder die dich aus anderer Perspektive stärken.
                </div>

                {% if selected_goal.people|length == 0 %}
                  <div class="muted">Noch niemand eingetragen. Füge Begleiter/Helfer hinzu.</div>
                {% endif %}

                <div class="stack" style="margin-top:10px">
                  {% for p in selected_goal.people %}
                    <form method="post" action="/goals/{{ selected_goal.id }}/people/{{ p.id }}/update" class="card" style="padding:12px">
                      <div class="row">
                        <div style="flex:1; min-width: 220px">
                          <label class="label">Name</label>
                          <input name="name" value="{{ p.name }}" />
                        </div>
                        <div style="min-width: 160px">
                          <label class="label">Rolle</label>
                          <select name="role" class="select">
                            <option value="companion" {% if p.role.value == 'companion' %}selected{% endif %}>Begleiter</option>
                            <option value="helper" {% if p.role.value == 'helper' %}selected{% endif %}>Helfer</option>
                          </select>
                        </div>
                        <div style="min-width: 160px">
                          <label class="label">Richtung</label>
                          <select name="direction" class="select">
                            <option value="with_me" {% if p.direction.value == 'with_me' %}selected{% endif %}>mit mir</option>
                            <option value="ahead" {% if p.direction.value == 'ahead' %}selected{% endif %}>ich gehe voran</option>
                          </select>
                        </div>
                      </div>
                      <label class="label" style="margin-top:8px">Notizen</label>
                      <textarea name="notes" placeholder="Wie hilft diese Person konkret?">{{ p.notes }}</textarea>
                      <div class="row" style="margin-top:8px">
                        <button type="submit">Speichern</button>
                        <button type="submit" formaction="/goals/{{ selected_goal.id }}/people/{{ p.id }}/delete" class="debug-clear" style="background: rgba(255,255,255,.06); color: var(--text)">Entfernen</button>
                      </div>
                    </form>
                  {% endfor %}
                </div>

                <form method="post" action="/goals/{{ selected_goal.id }}/people/add" class="stack" style="margin-top:12px">
                  <div class="row">
                    <div style="flex:1; min-width: 220px">
                      <label class="label">Neue Person</label>
                      <input name="name" placeholder="Name…" />
                    </div>
                    <div style="min-width: 160px">
                      <label class="label">Rolle</label>
                      <select name="role" class="select">
                        <option value="companion">Begleiter</option>
                        <option value="helper">Helfer</option>
                      </select>
                    </div>
                    <div style="min-width: 160px">
                      <label class="label">Richtung</label>
                      <select name="direction" class="select">
                        <option value="with_me">mit mir</option>
                        <option value="ahead">ich gehe voran</option>
                      </select>
                    </div>
                  </div>
                  <label class="label">Notizen</label>
                  <textarea name="notes" placeholder="Kontext, Erwartungen, Zusammenarbeit…"></textarea>
                  <button type="submit">Person hinzufügen</button>
                </form>
              </details>
            {% endif %}

            {% if selected_goal.decisions|length > 0 %}
              {% for d in selected_goal.decisions|sort(attribute='phase') %}
                <div class="card" style="margin-top:12px">
                  <div class="row">
                    <h3 style="margin:0">{{ d.title }}</h3>
                    <span class="pill">Phase {{ (d.phase or 0) + 1 }}</span>
                  </div>
                  {% if d.prompt %}
                    <div class="muted" style="margin:10px 0">{{ d.prompt }}</div>
                  {% endif %}
                  <div class="route-choices">
                    {% for opt in d.options %}
                      <form method="post" action="/goals/{{ selected_goal.id }}/decisions/{{ d.id }}/options/{{ opt.id }}/choose">
                        <button type="submit" class="route-choice {% if d.chosen_option_id and opt.id == d.chosen_option_id %}active{% endif %}">
                          {{ opt.label }}
                        </button>
                      </form>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            {% endif %}

          </section>

          <section class="card details">
            <h2>Arbeitspakete · Aktiver Pfad</h2>
            {% if path_routes|length == 0 %}
              <div class="muted">Noch keine Aufgaben. Klicke auf „KI: Plan erstellen“.</div>
            {% endif %}

            {% for r in path_routes %}
              <div class="task" style="border-top:none; padding-top:0; margin-top:0">
                <div class="row" style="margin: 18px 0 10px 0">
                  <div class="task-title" style="margin:0">{{ r.title }}</div>
                  <div class="row-right">
                    <span class="pill">Phase {{ (r.phase or 0) + 1 }}</span>
                    <span class="pill">{{ "Abschnitt" if r.kind.value == 'trunk' else "Abzweig" }}</span>
                  </div>
                </div>
                {% if r.description %}<div class="muted" style="margin-bottom:10px">{{ r.description }}</div>{% endif %}

                {% if r.tasks|length == 0 %}
                  <div class="muted">Noch keine Aufgaben in diesem Abschnitt.</div>
                {% endif %}

                {% for t in r.tasks %}
                  <div class="task">
                    <div class="task-title">{{ t.title }}</div>
                    {% if t.notes %}<div class="muted" style="margin-bottom:10px">{{ t.notes }}</div>{% endif %}
                    <div class="packages">
                      {% for wp in t.work_packages %}
                        <details class="package-item" id="wp-{{ wp.id }}">
                          <summary class="package-btn {% if wp.status.value == 'done' %}done{% endif %}">
                            <div class="package-title">{{ wp.title }}</div>
                            <div class="package-meta">Länge {{ wp.length }} · Steigung {{ wp.grade }}/10 · Status {{ 'erledigt' if wp.status.value == 'done' else ('umgeleitet' if wp.status.value == 'diverted' else 'offen') }}</div>
                          </summary>

                          <div class="package-actions">
                            <form method="post" action="/goals/{{ selected_goal.id }}/packages/{{ wp.id }}/toggle">
                              <button type="submit" class="package-action-btn">
                                {{ 'Undo' if wp.status.value == 'done' else 'Done' }}
                              </button>
                            </form>
                            <a class="package-action-link" href="/goals/{{ selected_goal.id }}/packages/{{ wp.id }}">Bearbeiten</a>
                          </div>

                          <div class="package-details">
                            {% set d = (wp.notes | wp_details(wp.title)) %}

                            {% if d.summary %}
                              <div class="wp-section">
                                <div class="wp-h">Kurzfassung</div>
                                <div class="muted" style="white-space: pre-wrap">{{ d.summary }}</div>
                              </div>
                            {% endif %}

                            {% if d.steps and d.steps|length > 0 %}
                              <div class="wp-section">
                                <div class="wp-h">Ablauf</div>
                                <div class="wp-flow" aria-label="Ablauf (Diagramm)">
                                  {% for s in d.steps[:6] %}
                                    <div class="wp-flow-step">{{ s }}</div>
                                  {% endfor %}
                                </div>
                                <ol class="wp-ol">
                                  {% for s in d.steps %}
                                    <li>{{ s }}</li>
                                  {% endfor %}
                                </ol>
                              </div>
                            {% endif %}

                            {% if d.checklist and d.checklist|length > 0 %}
                              <div class="wp-section">
                                <div class="wp-h">Definition of Done</div>
                                <div class="wp-checklist">
                                  {% for c in d.checklist %}
                                    <label class="wp-check">
                                      <input type="checkbox" disabled {% if c.done %}checked{% endif %} />
                                      <span>{{ c.text }}</span>
                                    </label>
                                  {% endfor %}
                                </div>
                              </div>
                            {% endif %}

                            {% if d.risks and d.risks|length > 0 %}
                              <div class="wp-section">
                                <div class="wp-h">Risiken & Stolpersteine</div>
                                <ul class="wp-ul">
                                  {% for r in d.risks %}
                                    <li>{{ r }}</li>
                                  {% endfor %}
                                </ul>
                              </div>
                            {% endif %}

                            {% if d.sources and d.sources|length > 0 %}
                              <div class="wp-section">
                                <div class="wp-h">Quellen</div>
                                <ul class="wp-ul">
                                  {% for u in d.sources %}
                                    <li><a class="link" href="{{ u }}" target="_blank" rel="noopener noreferrer">{{ u }}</a></li>
                                  {% endfor %}
                                </ul>
                              </div>
                            {% endif %}

                            {% if d.images and d.images|length > 0 %}
                              <div class="wp-section">
                                <div class="wp-h">Bilder</div>
                                <div class="wp-images">
                                  {% for u in d.images %}
                                    <a class="wp-image" href="{{ u }}" target="_blank" rel="noopener noreferrer">
                                      <img src="{{ u }}" alt="" loading="lazy" referrerpolicy="no-referrer" />
                                    </a>
                                  {% endfor %}
                                </div>
                              </div>
                            {% endif %}

                            {% if d.extra_sections %}
                              {% for k, v in d.extra_sections.items() %}
                                <div class="wp-section">
                                  <div class="wp-h">{{ k }}</div>
                                  <div class="muted" style="white-space: pre-wrap">{{ v }}</div>
                                </div>
                              {% endfor %}
                            {% endif %}

                            {% if (not d.summary) and (not d.steps) and (not d.checklist) and (not d.risks) and (not d.sources) and (not d.images) and (not d.extra_sections) %}
                              <div class="muted">Keine Details.</div>
                            {% endif %}
                          </div>
                        </details>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          </section>
        {% endif %}
      </section>
    </main>

    <footer class="footer">
      <span class="muted">Stellwerk · Persistenz: {{ persistence }}</span>
    </footer>

    {% include "debug_console.html" %}

    <div id="toastContainer" class="toast-container" aria-live="polite"></div>
    <script src="/static/toast.js"></script>

    <script>
      (() => {
        const openFromHash = () => {
          const h = window.location.hash || '';
          if (!h.startsWith('#wp-')) return;
          const el = document.querySelector(h);
          if (el && el.tagName && el.tagName.toLowerCase() === 'details') {
            el.open = true;
          }
        };
        window.addEventListener('hashchange', openFromHash);
        window.addEventListener('DOMContentLoaded', openFromHash);
      })();
    </script>
  </body>
</html>
