{% set routes = selected_goal.routes if selected_goal else [] %}
{% set decisions = selected_goal.decisions if selected_goal else [] %}
{% set edges = selected_goal.edges if selected_goal else [] %}
{% set active_path = path_routes if path_routes is defined else (selected_goal.selected_path_routes() if selected_goal else []) %}

{% set active_ids = [] %}
{% for r in active_path %}
  {% set _ = active_ids.append(r.id|string) %}
{% endfor %}

{# Lookups for graph rendering #}
{% set routes_by_id = {} %}
{% for r in routes %}
  {% set _ = routes_by_id.update({(r.id|string): r}) %}
{% endfor %}
{% set outgoing = {} %}
{% for e in edges %}
  {% set fk = e.from_route_id|string %}
  {% set tk = e.to_route_id|string %}
  {% if fk not in outgoing %}
    {% set _ = outgoing.update({fk: []}) %}
  {% endif %}
  {% set _ = outgoing[fk].append(tk) %}
{% endfor %}
{% set decisions_by_from = {} %}
{% for d in decisions %}
  {% if d.from_route_id %}
    {% set _ = decisions_by_from.update({(d.from_route_id|string): d}) %}
  {% endif %}
{% endfor %}

<div class="track-wrap">

  {% if not selected_goal or routes|length == 0 %}
    <div class="muted">Noch keine Strecke. Erstelle einen Plan.</div>
  {% else %}

    {# New HTML track map: show active trunk with explicit branch blocks and clickable work packages #}
    <div class="trackmap" role="navigation" aria-label="Strecke mit Arbeitspaketen">

      {% for r in active_path %}
        <div class="trackmap-node {% if r.id in active_ids %}active{% endif %}">
          <div class="trackmap-node-title">{{ r.title }}</div>
          <div class="trackmap-node-meta">Phase {{ (r.phase or 0) + 1 }} Â· {{ 'Abschnitt' if r.kind.value == 'trunk' else 'Abzweig' }}</div>

          {% set has_wps = namespace(v=false) %}
          {% for t in r.tasks %}
            {% if t.work_packages|length > 0 %}{% set has_wps.v = true %}{% endif %}
          {% endfor %}

          {% if has_wps.v %}
            <div class="trackmap-wps">
              {% for t in r.tasks %}
                {% for wp in t.work_packages %}
                  <a class="trackmap-wp {% if wp.status.value == 'done' %}done{% endif %}" href="#wp-{{ wp.id }}" title="{{ t.title }}">
                    {{ wp.title }}
                  </a>
                {% endfor %}
              {% endfor %}
            </div>
          {% else %}
            <div class="muted" style="margin-top:8px">Keine Arbeitspakete.</div>
          {% endif %}

          {# Branches at this node (graph schema) #}
          {% set d = decisions_by_from.get(r.id|string) %}
          {% if d and d.options|length > 0 %}
            <div class="trackmap-branch-title">Weiche: {{ d.title }}</div>
            <div class="trackmap-branches">
              {% set chosen_opt = d.chosen_option_id or (d.options[0].id if d.options|length > 0 else none) %}
              {% set next_active_id = (active_path[loop.index0 + 1].id|string) if loop.index0 + 1 < active_path|length else '' %}

              {% for opt in d.options %}
                {% set br = routes_by_id.get(opt.route_id|string) %}
                {% set is_chosen = (chosen_opt and opt.id == chosen_opt) %}
                {% set is_next = (next_active_id and (opt.route_id|string) == next_active_id) %}

                <div class="trackmap-branch {% if is_chosen %}chosen{% endif %}{% if is_next %} active{% endif %}">
                  <div class="trackmap-branch-head">
                    <div class="trackmap-branch-label">{{ opt.label }}</div>
                    {% if br %}<div class="trackmap-branch-route">{{ br.title }}</div>{% endif %}
                  </div>

                  {% if br %}
                    <div class="trackmap-wps">
                      {% for t in br.tasks %}
                        {% for wp in t.work_packages %}
                          <a class="trackmap-wp {% if wp.status.value == 'done' %}done{% endif %}" href="#wp-{{ wp.id }}" title="{{ t.title }}">
                            {{ wp.title }}
                          </a>
                        {% endfor %}
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="muted">(Route fehlt)</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
