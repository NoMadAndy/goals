{% set routes = [] %}
{% if selected_goal %}
  {% for r in selected_goal.routes %}
    {% set _ = routes.append(r) %}
  {% endfor %}
{% endif %}

{% set active_route = None %}
{% if selected_goal %}
  {% set active_route = selected_goal.selected_route() %}
{% endif %}

{% set lane_count = routes|length %}
{% if lane_count == 0 %}{% set lane_count = 1 %}{% endif %}
{% set lane_gap = 86 %}
{% set lane_start_y = 64 %}
{% set vb_h = lane_start_y + (lane_count * lane_gap) %}

<div class="track-wrap">
  <div class="track-legend">
    <span class="pill">Länge = Aufwand</span>
    <span class="pill">Steigung = Schwierigkeit</span>
    <span class="pill">Klick auf Arbeitspaket: erledigt ↔ offen</span>
  </div>

  <svg class="track" viewBox="0 0 1000 {{ vb_h }}" preserveAspectRatio="xMinYMin meet" role="img" aria-label="Zugstrecke mit Weichen und Routen">
    <!-- Weiche (symbolisch) -->
    <g transform="translate(60,30)">
      <circle cx="70" cy="40" r="12" class="wheel" />
      <line x1="82" y1="40" x2="120" y2="40" class="rail" />
      {% for i in range(0, routes|length) %}
        {% set y = lane_start_y + (i * lane_gap) + 48 %}
        <line x1="120" y1="40" x2="150" y2="{{ y }}" class="sleeper" />
      {% endfor %}
      <text x="0" y="15" class="muted-svg">Weiche</text>
    </g>

    <!-- Pro Route eine Spur (zwei Schienen + Schwellen) + Waggons -->
    {% for r in routes %}
      {% set lane_i = loop.index0 %}
      {% set y1 = lane_start_y + (lane_i * lane_gap) + 48 %}
      {% set y2 = y1 + 22 %}

      {% set is_active = (active_route and r.id == active_route.id) %}

      <line x1="150" y1="{{ y1 }}" x2="960" y2="{{ y1 }}" class="rail{% if is_active %} active{% endif %}" />
      <line x1="150" y1="{{ y2 }}" x2="960" y2="{{ y2 }}" class="rail{% if is_active %} active{% endif %}" />

      {% for i in range(0, 26) %}
        <line x1="{{ 170 + i*32 }}" y1="{{ y1 - 8 }}" x2="{{ 170 + i*32 }}" y2="{{ y2 + 8 }}" class="sleeper" />
      {% endfor %}

      <!-- Routenlabel -->
      <text x="150" y="{{ y1 - 16 }}" class="wagon-meta">{{ r.title }}</text>

      <!-- Waggons dieser Route -->
      {% set segments = [] %}
      {% for t in r.tasks %}
        {% for wp in t.work_packages %}
          {% set _ = segments.append(wp) %}
        {% endfor %}
      {% endfor %}

      {% set total = 0 %}
      {% for s in segments %}
        {% set total = total + (s.length or 1) %}
      {% endfor %}
      {% if total == 0 %}{% set total = 1 %}{% endif %}

      {% set seg_count = segments|length %}
      {% set gap = 10 %}
      {% set track_len = 780 - (gap * (seg_count - 1)) %}
      {% if track_len < 240 %}
        {% set gap = 6 %}
        {% set track_len = 780 - (gap * (seg_count - 1)) %}
      {% endif %}
      {% if track_len < 140 %}{% set track_len = 140 %}{% endif %}

      {% set ns = namespace(x=170) %}
      {% for s in segments %}
        {% set w = track_len * ( (s.length or 1) / total ) %}
        {% if w < 34 %}{% set w = 34 %}{% endif %}
        {% set g = (s.grade or 0) %}
        {% set y = y1 - 34 - (g * 1.6) %}
        {% set rw = (w|float) - 20 %}

        <g transform="translate({{ ns.x }},{{ y }})">
          <rect x="0" y="0" width="{{ w }}" height="50" rx="14" class="wagon {% if s.status.value == 'done' %}done{% endif %}" />
          <text x="12" y="20" class="wagon-title">{{ s.title }}</text>
          <text x="12" y="38" class="wagon-meta">L {{ s.length }} · S {{ s.grade }}/10</text>
          <circle cx="20" cy="68" r="10" class="wheel" />
          <circle cx="{{ 20 if rw < 20 else rw }}" cy="68" r="10" class="wheel" />
        </g>

        {% set ns.x = ns.x + w + gap %}
      {% endfor %}

      {% if segments|length == 0 %}
        <text x="170" y="{{ y1 - 10 }}" class="muted-svg">Diese Route hat noch keine Arbeitspakete.</text>
      {% endif %}
    {% endfor %}

    {% if routes|length == 0 %}
      <text x="160" y="70" class="muted-svg">Noch keine Strecke. Erstelle einen Plan.</text>
    {% endif %}
  </svg>
</div>
